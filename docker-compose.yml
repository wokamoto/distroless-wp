services:
  php:
    build:
      context: .
      dockerfile: ./bin/wordpress/${PHPVERSION}/Dockerfile
      args:
        WP_VERSION: ${WP_VERSION-latest}
        TIME_ZONE: ${TIME_ZONE-Asia/Tokyo}
    image: distroless-wp:wordpress-${PHPVERSION}
    container_name: "${COMPOSE_PROJECT_NAME}-${PHPVERSION}"
    restart: "always"
    expose:
      - "9000"
    depends_on:
      database:
        condition: service_healthy
    volumes:
      - ${WP_CONFIG_FILE-./www/wp-config.php}:/var/www/html/wp/wp-config.php:ro
      - ${WP_CONTENT_DIR-./www/content}/languages:/var/www/html/assets/languages:rw
      - ${WP_CONTENT_DIR-./www/content}/mu-plugins:/var/www/html/assets/mu-plugins:rw
      - ${WP_CONTENT_DIR-./www/content}/plugins:/var/www/html/assets/plugins:rw
      - ${WP_CONTENT_DIR-./www/content}/themes:/var/www/html/assets/themes:rw
      - ${WP_CONTENT_DIR-./www/content}/uploads:/var/www/html/assets/uploads:rw
      - ${PHP_FPM_LOG_DIR-./logs/php-fpm}:/var/log/php-fpm
    environment:
      STAGE: ${STAGE-local}
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_HOST: database
      AUTH_KEY: ${AUTH_KEY-change-this-auth-key}
      SECURE_AUTH_KEY: ${SECURE_AUTH_KEY-change-this-secure-auth-key}
      LOGGED_IN_KEY: ${LOGGED_IN_KEY-change-this-logged-in-key}
      NONCE_KEY: ${NONCE_KEY-change-this-nonce-key}
      AUTH_SALT: ${AUTH_SALT-change-this-auth-salt}
      SECURE_AUTH_SALT: ${SECURE_AUTH_SALT-change-this-secure-auth-salt}
      LOGGED_IN_SALT: ${LOGGED_IN_SALT-change-this-logged-in-salt}
      NONCE_SALT: ${NONCE_SALT-change-this-nonce-salt}
    extra_hosts:
      - "host.docker.internal:host-gateway"
  wp-cli:
    build:
      context: .
      dockerfile: ./bin/wordpress/cli/Dockerfile
      args:
        WP_VERSION: ${WP_VERSION-latest}
        TIME_ZONE: ${TIME_ZONE-Asia/Tokyo}
    image: distroless-wp:wp-cli
    container_name: "${COMPOSE_PROJECT_NAME}-wp-cli"
    restart: "always"
    command:
      - /usr/bin/sh
      - -c
      - /usr/bin/sh /usr/local/bin/update-wordpress-languages.sh && while true; do sleep 3600; done
    depends_on:
      database:
        condition: service_healthy
    volumes:
      - ${WP_CONFIG_FILE-./www/wp-config.php}:/var/www/html/wp/wp-config.php:ro
      - ${WP_CONTENT_DIR-./www/content}/languages:/var/www/html/assets/languages:rw
      - ${WP_CONTENT_DIR-./www/content}/mu-plugins:/var/www/html/assets/mu-plugins:rw
      - ${WP_CONTENT_DIR-./www/content}/plugins:/var/www/html/assets/plugins:rw
      - ${WP_CONTENT_DIR-./www/content}/themes:/var/www/html/assets/themes:rw
      - ${WP_CONTENT_DIR-./www/content}/uploads:/var/www/html/assets/uploads:rw
    environment:
      STAGE: ${STAGE-local}
      WP_CLI_ALLOW_ROOT: "true"
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      DB_HOST: database
      AUTH_KEY: ${AUTH_KEY-change-this-auth-key}
      SECURE_AUTH_KEY: ${SECURE_AUTH_KEY-change-this-secure-auth-key}
      LOGGED_IN_KEY: ${LOGGED_IN_KEY-change-this-logged-in-key}
      NONCE_KEY: ${NONCE_KEY-change-this-nonce-key}
      AUTH_SALT: ${AUTH_SALT-change-this-auth-salt}
      SECURE_AUTH_SALT: ${SECURE_AUTH_SALT-change-this-secure-auth-salt}
      LOGGED_IN_SALT: ${LOGGED_IN_SALT-change-this-logged-in-salt}
      NONCE_SALT: ${NONCE_SALT-change-this-nonce-salt}
    working_dir: /var/www/html/wp
    extra_hosts:
      - "host.docker.internal:host-gateway"
  webserver:
    build:
      context: .
      dockerfile: ./bin/webserver/${WEBSERVER-nginx}/Dockerfile
      args:
        WP_VERSION: ${WP_VERSION-latest}
        TIME_ZONE: ${TIME_ZONE-Asia/Tokyo}
    image: distroless-wp:${WEBSERVER-nginx}
    container_name: "${COMPOSE_PROJECT_NAME}-${WEBSERVER-nginx}"
    restart: "always"
    depends_on:
      - php
    ports:
      - "${HOST_MACHINE_UNSECURE_HOST_PORT}:80"
      - "${HOST_MACHINE_SECURE_HOST_PORT}:443"
    volumes:
      - ${WP_CONTENT_DIR-./www/content}/mu-plugins:/var/www/html/assets/mu-plugins:ro
      - ${WP_CONTENT_DIR-./www/content}/plugins:/var/www/html/assets/plugins:ro
      - ${WP_CONTENT_DIR-./www/content}/themes:/var/www/html/assets/themes:ro
      - ${WP_CONTENT_DIR-./www/content}/uploads:/var/www/html/assets/uploads:ro
      - ${NGINX_LOG_DIR-./logs/nginx}:/var/log/nginx
      - ${HTTPD_LOG_DIR-./logs/httpd}:/var/log/httpd
    extra_hosts:
      - "host.docker.internal:host-gateway"
  database:
    build:
      context: .
      dockerfile: ./bin/database/${DATABASE}/Dockerfile
    image: distroless-wp:${DATABASE}
    container_name: "${COMPOSE_PROJECT_NAME}-${DATABASE}"
    restart: "always"
    expose:
      - "3306"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mysql -u root -p$$MYSQL_ROOT_PASSWORD -e 'SELECT 1' || exit 1",
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    volumes:
      - dbdata:/var/lib/mysql
      - ${MYSQL_INITDB_DIR-./config/initdb}:/docker-entrypoint-initdb.d
      - ${MYSQL_LOG_DIR-./logs/mysql}:/var/log/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
  phpmyadmin:
    image: phpmyadmin
    container_name: "${COMPOSE_PROJECT_NAME}-phpmyadmin"
    depends_on:
      database:
        condition: service_healthy
    environment:
      PMA_HOST: database
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      UPLOAD_LIMIT: ${UPLOAD_LIMIT}
      MEMORY_LIMIT: ${MEMORY_LIMIT}
    ports:
      - "${HOST_MACHINE_PMA_PORT}:80"
      - "${HOST_MACHINE_PMA_SECURE_PORT}:443"
    volumes:
      - /sessions
      - ${PHP_INI-./config/php/php.ini}:/usr/local/etc/php/conf.d/php-phpmyadmin.ini
  mail:
    image: axllent/mailpit:latest
    container_name: "${COMPOSE_PROJECT_NAME}-mail"
    expose:
      - "1025"
    ports:
      - "${HOST_MACHINE_MAILPIT_PORT}:8025"
    volumes:
      - mailpitdata:/data
    environment:
      TZ: ${TIME_ZONE-Asia/Tokyo}
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1

volumes:
  dbdata:
  mailpitdata:
