<VirtualHost *:80>
    ServerName localhost
    DocumentRoot "/var/www/html"

    <Directory "/var/www/html">
        Options FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Deny hidden files except ".well-known".
    RedirectMatch 403 "(?i)/\\.(?!well-known(?:/|$))"

    # Block direct access to top-level wp-* paths.
    RedirectMatch 404 "(?i)^/wp-(admin/.*|includes/.*|content/.*|wp-.*\\.php)$"
    RedirectMatch 404 "(?i)(/(?:uploads|files)/.*\\.php|.*\\.(cache|sql|log|ba?k|org))$"

    RewriteEngine On
    RewriteRule ^/assets/includes/(.*)$ /wp/wp-includes/$1 [L]

    # Keep /assets and /wp strict like nginx's try_files ... =404.
    RewriteCond %{REQUEST_URI} ^/assets/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ - [R=404,L]

    # WordPress front controller.
    RewriteCond %{REQUEST_URI} !^/assets/
    RewriteCond %{REQUEST_URI} !^/wp/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ /index.php [QSA,L]

    <LocationMatch "^/assets/(languages|themes|uploads|upgrade)/.*\\.php$">
        Require all denied
    </LocationMatch>

    <LocationMatch "^/wp/(wp-config|xmlrpc|wp-blog-header|index)\\.php$">
        Require all denied
    </LocationMatch>

    <LocationMatch "^/wp/wp-includes/.*\\.php$">
        Require all denied
    </LocationMatch>

    ProxyFCGIBackendType GENERIC
    ProxyTimeout 180

    <FilesMatch "\\.php$">
        SetHandler "proxy:fcgi://php:9000"
    </FilesMatch>

    RequestHeader set X-Forwarded-Proto "expr=%{REQUEST_SCHEME}"
    SetEnvIfNoCase X-Forwarded-Proto "^https$" HTTPS=on
</VirtualHost>
